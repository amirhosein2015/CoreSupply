version: '3.4'

services:

  # --- INFRASTRUCTURE (Minimal) ---

  catalogdb:
    image: mongo
    container_name: core.catalogdb
    ports:
      - "27017:27017"
    volumes:
      - coresupply-catalog-data:/data/db
    networks:
      - coresupply_network
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.runCommand({ping: 1}).ok"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  redis:
    image: redis:alpine
    container_name: core.redis
    ports:
      - "6379:6379"
    networks:
      - coresupply_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  quotedb:
    image: mongo
    container_name: core.quotedb
    volumes:
      - coresupply-quote-data:/data/db
    networks:
      - coresupply_network
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.runCommand({ping: 1}).ok"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # --- CORE SERVICES ---
  # مسیردهی فلت (تایید شده)
  
  catalog.api:
    image: ${DOCKER_REGISTRY-}catalogapi
    build:
      context: .
      dockerfile: CoreSupply.Catalog.API/Dockerfile 
    ports:
      - "8000:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - DatabaseSettings__ConnectionString=mongodb://core.catalogdb:27017
    depends_on:
      catalogdb:
        condition: service_healthy
    networks:
      - coresupply_network

  quote.api:
    image: ${DOCKER_REGISTRY-}quoteapi
    build:
      context: .
      dockerfile: CoreSupply.Quote.API/Dockerfile 
    ports:
      - "8001:8081"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8081
      - DatabaseSettings__ConnectionString=mongodb://core.quotedb:27017
      - CacheSettings__ConnectionString=core.redis:6379
    depends_on:
      quotedb:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - coresupply_network
      
  apigateway:
    image: ${DOCKER_REGISTRY-}apigateway
    build:
      context: .
      dockerfile: CoreSupply.APIGateway/Dockerfile 
    ports:
      - "8002:80" 
    depends_on:
      catalog.api:
        condition: service_started
      quote.api:
        condition: service_started
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
    networks:
      - coresupply_network

volumes:
  coresupply-catalog-data:
  # coresupply-pricing-data: # حذف شد
  coresupply-quote-data:

networks:
  coresupply_network:
    driver: bridge