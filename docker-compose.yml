version: '3.4'

services:
  # --- INFRASTRUCTURE (SAFE PORTS: 6000+) ---

  catalogdb:
    image: mongo:6.0
    container_name: core.catalogdb
    ports:
      - "27017:27017"
    volumes:
      - coresupply-catalog-data:/data/db
    networks:
      - coresupply_network
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.runCommand({ping: 1}).ok"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  redis:
    image: redis:7.0-alpine
    container_name: core.redis
    ports:
      - "6379:6379"
    networks:
      - coresupply_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # --- NEW: SEQ LOGGING SERVER ---
  seq:
    image: datalust/seq:latest
    container_name: core.seq
    ports:
      - "5340:80"
      - "5341:5341"
    environment:
      - ACCEPT_EULA=Y
      - SEQ_FIRSTRUN_ADMINPASSWORD_HASH=phArgon2$v=19$m=65536,t=3,p=4$U2VxQWRtaW4xMjM0NQ$X/L7/q/X/L7/q/X/L7/q/X/L7/q/X/L7/q/X/L7/q/X
      # یا روش ساده‌تر (برای محیط توسعه):
      - SEQ_FIRSTRUN_ADMINPASSWORD=Password12!
    networks:
      - coresupply_network


  quotedb:
    image: mongo:6.0
    container_name: core.quotedb
    volumes:
      - coresupply-quote-data:/data/db
    networks:
      - coresupply_network
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.runCommand({ping: 1}).ok"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  pricingdb:
    image: postgres
    container_name: core.pricingdb
    ports:
      - "6432:5432" # Safe Port
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=Password12!
      - POSTGRES_DB=pricing
    volumes:
      - coresupply-pricing-data:/var/lib/postgresql/data
    networks:
      - coresupply_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d pricing"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  identitydb:
    image: postgres:15-alpine
    container_name: core.identitydb
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=Password12!
      - POSTGRES_DB=identitydb
    ports:
      - "6433:5432" # Safe Port
    volumes:
      - coresupply-identity-data:/var/lib/postgresql/data
    networks:
      - coresupply_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d identitydb"]
      interval: 10s
      timeout: 5s
      retries: 5

  procurementdb:
    image: mcr.microsoft.com/mssql/server:2019-latest
    container_name: core.procurementdb
    environment:
      - SA_PASSWORD=Password12!
      - ACCEPT_EULA=Y
    ports:
      - "1433:1433"
    networks:
      - coresupply_network
    healthcheck:
      test: ["CMD", "/opt/mssql-tools/bin/sqlcmd", "-S", "localhost", "-U", "sa", "-P", "Password12!", "-Q", "SELECT 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  eventbus:
    image: rabbitmq:3.12-management
    container_name: core.eventbus
    ports:
      - "6672:5672"
      - "16672:15672"
    networks:
      - coresupply_network

  # --- CORE SERVICES (FINAL SAFE PORTS: 9000+) ---

  catalog.api:
    image: ${DOCKER_REGISTRY-}catalogapi
    build:
      context: .
      dockerfile: CoreSupply.Catalog.API/Dockerfile
    ports:
      - "9001:8080" 
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - DatabaseSettings__ConnectionString=mongodb://core.catalogdb:27017
    depends_on:
      catalogdb:
        condition: service_healthy
    networks:
      - coresupply_network

  quote.api:
    image: ${DOCKER_REGISTRY-}quoteapi
    build:
      context: .
      dockerfile: CoreSupply.Quote.API/Dockerfile
    ports:
      - "9002:8081"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8081
      - DatabaseSettings__ConnectionString=mongodb://core.quotedb:27017
      - CacheSettings__ConnectionString=core.redis:6379
    depends_on:
      quotedb:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - coresupply_network

  identity.api:
    image: ${DOCKER_REGISTRY-}identityapi
    build:
      context: .
      dockerfile: CoreSupply.Identity.API/Dockerfile
    ports:
      - "9003:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - DatabaseSettings__ConnectionString=Host=core.identitydb;Port=5432;Database=identitydb;Username=admin;Password=Password12!;
      - JwtSettings__Secret=ThisIsTheSecureKeyForCoreSupplyProject2025!
      - JwtSettings__Issuer=CoreSupplyIdentity
      - JwtSettings__Audience=CoreSupplyClients
    depends_on:
      identitydb:
        condition: service_healthy
    networks:
      - coresupply_network

  ordering.api:
    image: ${DOCKER_REGISTRY-}orderingapi
    build:
      context: .
      dockerfile: CoreSupply.Ordering.API/Dockerfile
    ports:
      - "9004:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__OrderingConnectionString=Server=core.procurementdb,1433;Database=OrderingDb;User Id=sa;Password=Password12!;TrustServerCertificate=True;
    depends_on:
      procurementdb:
        condition: service_started
    networks:
      - coresupply_network

  apigateway:
    image: ${DOCKER_REGISTRY-}apigateway
    build:
      context: .
      dockerfile: CoreSupply.APIGateway/Dockerfile
    ports:
      - "9000:8080"
    depends_on:
      catalog.api:
        condition: service_started
      quote.api:
        condition: service_started
      ordering.api:
        condition: service_started
      identity.api:
        condition: service_started
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
    networks:
      - coresupply_network

volumes:
  coresupply-catalog-data:
  coresupply-pricing-data:
  coresupply-quote-data:
  coresupply-identity-data:

networks:
  coresupply_network:
    driver: bridge
